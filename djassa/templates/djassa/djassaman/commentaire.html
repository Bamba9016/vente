{% extends 'djassa/djassaman/base.html' %}

{% block content %}
<style>
    body {
        overflow-x: hidden;
    }

    .comment-page {
        max-width: 600px;
        margin: auto;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        margin-top: 30px;
        padding: 0;
        overflow: hidden;
    }

    .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #ccc;
        background-color: #f7f7f7;
    }

    .comments-body {
        max-height: 60vh;
        overflow-y: auto;
        padding: 15px 20px;
    }

    .comment-input {
        border-top: 1px solid #ccc;
        padding: 15px 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .comment-input textarea {
        resize: none;
        flex-grow: 1;
    }

    .comment {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .comment .avatar img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
        margin-right: 10px;
    }

    .comment .content {
        max-width: 450px;
        word-wrap: break-word;
        background-color: #e0e0e0;
        padding: 10px;
        border-radius: 10px;
    }

    .reply {
        display: flex;
        align-items: flex-start;
        margin-top: 10px;
        margin-left: 50px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 10px;
    }

    .reply-form {
        display: none;
        margin-top: 10px;
        margin-left: 50px;
    }

    .reply-btn, .see-replies-btn {
        font-size: 0.9rem;
        color: #007bff;
        cursor: pointer;
        margin-top: 8px;
        display: inline-block;
    }

    .replies {
        display: none;
    }

    .replies.visible {
        display: block;
    }
</style>

<div class="comment-page">
    <div class="drawer-header">
        <h5 class="mb-0">Commentaires pour : {{ publication.nom_du_produit }}</h5>
        <a href="{% url 'accueil' %}" class="btn-close">&times;</a>
    </div>
    <div class="comments-body" id="comments-container">
        {% for comment in comments %}
            {% if not comment.parent_comment %}
                <div class="comment" id="comment-{{ comment.id }}" data-comment-id="{{ comment.id }}">
                    <div class="avatar">
                        <a href="{% url 'profilepublication' comment.user.id %}">
                            <img src="{% if comment.user.profile_picture %}{{ comment.user.profile_picture.url }}{% else %}https://placehold.co/120x120{% endif %}" alt="Avatar">
                        </a>
                    </div>
                    <div class="content">
                        <strong>{{ comment.user.username }}</strong> : {{ comment.content }}
                        <div>
                            <span class="reply-btn" onclick="toggleReplyForm({{ comment.id }})">Répondre</span>
                        </div>
                        <div class="reply-form" id="replyForm-{{ comment.id }}">
                            <textarea class="form-control reply-textarea" rows="2" placeholder="Répondre..." data-parent-id="{{ comment.id }}" required></textarea>
                            <button class="btn btn-primary mt-2 send-reply-btn" data-parent-id="{{ comment.id }}">Envoyer</button>
                        </div>
                        {% if comment.replies.count > 0 %}
                            <span class="see-replies-btn" onclick="toggleReplies({{ comment.id }}, this)">Voir les réponses</span>
                        {% endif %}
                        <div class="replies" id="replies-{{ comment.id }}">
                            {% for reply in comment.replies.all %}
                                <div class="reply">
                                    <div class="avatar">
                                        <a href="{% url 'profilepublication' reply.user.id %}">
                                            <img src="{% if reply.user.profile_picture %}{{ reply.user.profile_picture.url }}{% else %}https://placehold.co/120x120{% endif %}" alt="Avatar">
                                        </a>
                                    </div>
                                    <div class="content">
                                        <strong>{{ reply.user.username }}</strong> : {{ reply.content }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% empty %}
            <p>Aucun commentaire pour cette publication.</p>
        {% endfor %}
    </div>
    <div class="comment-input">
        {% csrf_token %}
        <textarea id="newComment" class="form-control" rows="1" placeholder="Ajouter un commentaire..." required></textarea>
        <button id="submitComment" class="btn btn-primary">Envoyer</button>
    </div>

</div>

<script>
    const publicationId = {{ publication.id }};
    const commentsContainer = document.getElementById('comments-container');
    const newCommentInput = document.getElementById('newComment');
    const submitCommentButton = document.getElementById('submitComment');

    const commentSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/publication/' + publicationId + '/comments/'
    );

    commentSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'comment') {
            const comment = data.comment;
            const newCommentDiv = document.createElement('div');
            newCommentDiv.classList.add('comment');
            newCommentDiv.id = `comment-${comment.id}`;
            newCommentDiv.dataset.commentId = comment.id;

            const avatarDiv = document.createElement('div');
            avatarDiv.classList.add('avatar');
            const avatarLink = document.createElement('a');
            avatarLink.href = comment.user.profile_url;
            const avatarImg = document.createElement('img');
            avatarImg.src = comment.user.profile_picture;
            avatarImg.alt = 'Avatar';
            avatarLink.appendChild(avatarImg);
            avatarDiv.appendChild(avatarLink);
            newCommentDiv.appendChild(avatarDiv);

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('content');
            contentDiv.innerHTML = `<strong>${comment.user.username}</strong> : ${comment.content}
                <div>
                    <span class="reply-btn" onclick="toggleReplyForm(${comment.id})">Répondre</span>
                </div>
                <div class="reply-form" id="replyForm-${comment.id}">
                    <textarea class="form-control reply-textarea" rows="2" placeholder="Répondre..." data-parent-id="${comment.id}" required></textarea>
                    <button class="btn btn-primary mt-2 send-reply-btn" data-parent-id="${comment.id}">Envoyer</button>
                </div>
                <div class="replies" id="replies-${comment.id}"></div>
            `;
            newCommentDiv.appendChild(contentDiv);

            // Ajouter le nouveau commentaire en haut
            commentsContainer.prepend(newCommentDiv);
            attachReplyEventListeners(); // Ré-attacher les listeners pour les nouveaux éléments
        }
    };

    commentSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    submitCommentButton.onclick = function(e) {
        const commentContent = newCommentInput.value;
        if (commentContent) {
            commentSocket.send(JSON.stringify({
                'type': 'new_comment',
                'content': commentContent
            }));
            newCommentInput.value = '';
        }
    };

    function toggleReplyForm(commentId) {
        const form = document.getElementById('replyForm-' + commentId);
        form.style.display = form.style.display === 'block' ? 'none' : 'block';
    }

    function toggleReplies(commentId, btn) {
        const replies = document.getElementById('replies-' + commentId);
        replies.classList.toggle('visible');
        btn.innerText = replies.classList.contains('visible') ? 'Masquer les réponses' : 'Voir les réponses';
    }

    function sendReply(parentId, replyContent) {
        commentSocket.send(JSON.stringify({
            'type': 'new_reply',
            'content': replyContent,
            'parent_id': parentId
        }));
    }

    function attachReplyEventListeners() {
        const replyButtons = document.querySelectorAll('.send-reply-btn');
        replyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const parentId = this.dataset.parentId;
                const replyTextarea = document.querySelector(`#replyForm-${parentId} .reply-textarea`);
                if (replyTextarea && replyTextarea.value) {
                    sendReply(parentId, replyTextarea.value);
                    replyTextarea.value = ''; // Clear the textarea after sending
                    const replyForm = document.getElementById(`replyForm-${parentId}`);
                    replyForm.style.display = 'none'; // Hide the form after sending
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        attachReplyEventListeners();

        // Sauvegarder la position du scroll avant l'actualisation
        window.addEventListener('beforeunload', function() {
            const scrollPosition = document.querySelector('.comments-body').scrollTop;
            sessionStorage.setItem('commentScrollPosition', scrollPosition);
        });

        // Restaurer la position du scroll après le chargement
        const savedPosition = sessionStorage.getItem('commentScrollPosition');
        if (savedPosition) {
            const commentsBody = document.querySelector('.comments-body');
            commentsBody.scrollTop = savedPosition;
            sessionStorage.removeItem('commentScrollPosition'); // Nettoyer après utilisation
        }
    });

    document.addEventListener('pageshow', function (event) {
        if (event.persisted || window.performance.getEntriesByType("navigation")[0].type === "back_forward") {
            window.location.href = "{% url 'accueil' %}";
        }
    });
</script>

{% endblock %}