{% extends 'djassa/djassaman/base.html' %}

{% block content %}
<style>
    body {
        overflow-x: hidden;
    }

    .comment-page {
        max-width: 600px;
        margin: auto;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        margin-top: 30px;
        padding: 0;
        overflow: hidden;
    }

    .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #ccc;
        background-color: #f7f7f7;
    }

    .comments-body {
        max-height: 60vh;
        overflow-y: auto;
        padding: 15px 20px;
    }

    .comment-input {
        border-top: 1px solid #ccc;
        padding: 15px 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .comment-input textarea {
        resize: none;
        flex-grow: 1;
    }

    .comment {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .comment .avatar img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
        margin-right: 10px;
    }

    .comment .content {
        max-width: 450px;
        word-wrap: break-word;
        background-color: #e0e0e0;
        padding: 10px;
        border-radius: 10px;
    }

    .reply {
        display: flex;
        align-items: flex-start;
        margin-top: 10px;
        margin-left: 50px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 10px;
    }

    .reply-form {
        display: none;
        margin-top: 10px;
        margin-left: 50px;
    }

    .reply-btn, .see-replies-btn {
        font-size: 0.9rem;
        color: #007bff;
        cursor: pointer;
        margin-top: 8px;
        display: inline-block;
    }

    .replies {
        display: none;
    }

    .replies.visible {
        display: block;
    }
</style>

<div class="comment-page">
    <div class="drawer-header">
        <h5 class="mb-0">Commentaires pour : {{ publication.nom_du_produit }}</h5>
        <a href="{% url 'accueil' %}" class="btn-close">&times;</a>
    </div>
    <div class="comments-body">
        {% for comment in comments %}
            {% if not comment.parent_comment %}
                <div class="comment" id="comment-{{ comment.id }}">
                    <div class="avatar">
                        <a href="{% url 'profilepublication' comment.user.id %}">
                            <img src="{% if comment.user.profile_picture %}{{ comment.user.profile_picture.url }}{% else %}https://placehold.co/120x120{% endif %}" alt="Avatar">
                        </a>
                    </div>
                    <div class="content">
                        <strong>{{ comment.user.username }}</strong> : {{ comment.content }}
                        <div>
                            <span class="reply-btn" onclick="toggleReplyForm({{ comment.id }})">Répondre</span>
                        </div>
                        <div class="reply-form" id="replyForm-{{ comment.id }}">
                            <form action="{% url 'reply_to_comment' comment.id %}" method="post">
                                {% csrf_token %}
                                <textarea name="reply" class="form-control" rows="2" placeholder="Répondre..." required></textarea>
                                <button type="submit" class="btn btn-primary mt-2">Envoyer</button>
                            </form>
                        </div>
                        {% if comment.replies.count > 0 %}
                            <span class="see-replies-btn" onclick="toggleReplies({{ comment.id }}, this)">Voir les réponses</span>
                        {% endif %}
                        <div class="replies" id="replies-{{ comment.id }}">
                            {% for reply in comment.replies.all %}
                                <div class="reply">
                                    <div class="avatar">
                                        <a href="{% url 'profilepublication' reply.user.id %}">
                                            <img src="{% if reply.user.profile_picture %}{{ reply.user.profile_picture.url }}{% else %}https://placehold.co/120x120{% endif %}" alt="Avatar">
                                        </a>
                                    </div>
                                    <div class="content">
                                        <strong>{{ reply.user.username }}</strong> : {{ reply.content }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% empty %}
            <p>Aucun commentaire pour cette publication.</p>
        {% endfor %}
    </div>
    <form id="commentForm" method="post" action="{% url 'comment_publication' publication.id %}" class="comment-input">
        {% csrf_token %}
        <textarea name="comment" class="form-control" rows="1" placeholder="Ajouter un commentaire..." required></textarea>
        <button type="submit" class="btn btn-primary">Envoyer</button>
    </form>

</div>

<script>
// Sauvegarder la position du scroll avant l'actualisation
window.addEventListener('beforeunload', function() {
    const scrollPosition = document.querySelector('.comments-body').scrollTop;
    sessionStorage.setItem('commentScrollPosition', scrollPosition);
});

// Restaurer la position du scroll après le chargement
document.addEventListener('DOMContentLoaded', function() {
    // Fonctions existantes...
    toggleReplyForm = function(commentId) {
        const form = document.getElementById('replyForm-' + commentId);
        form.style.display = form.style.display === 'block' ? 'none' : 'block';
    }

    toggleReplies = function(commentId, btn) {
        const replies = document.getElementById('replies-' + commentId);
        replies.classList.toggle('visible');
        btn.innerText = replies.classList.contains('visible') ? 'Masquer les réponses' : 'Voir les réponses';
    }

    // Restaurer la position du scroll
    const savedPosition = sessionStorage.getItem('commentScrollPosition');
    if (savedPosition) {
        const commentsBody = document.querySelector('.comments-body');
        commentsBody.scrollTop = savedPosition;
        sessionStorage.removeItem('commentScrollPosition'); // Nettoyer après utilisation
    }

    // Ajout pour le scroll après soumission de formulaire
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function() {
            const scrollPosition = document.querySelector('.comments-body').scrollTop;
            sessionStorage.setItem('commentScrollPosition', scrollPosition);
        });
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ... le reste de ton script déjà présent ...

    const commentForm = document.getElementById('commentForm');
    commentForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(commentForm);
        const comment = formData.get('comment');
        const csrfToken = formData.get('csrfmiddlewaretoken');

        fetch(commentForm.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const commentsBody = document.querySelector('.comments-body');

                const newCommentHTML = `
                    <div class="comment">
                        <div class="avatar">
                            <a href="${data.comment.user_profile_url}">
                                <img src="${data.comment.user_avatar}" alt="Avatar">
                            </a>
                        </div>
                        <div class="content">
                            <strong>${data.comment.username}</strong> : ${data.comment.content}
                        </div>
                    </div>
                `;

                commentsBody.insertAdjacentHTML('beforeend', newCommentHTML);
                commentForm.reset();
            } else {
                alert('Erreur : ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur lors de l\'envoi du commentaire :', error);
        });
    });
});
</script>
<script>
    document.addEventListener('pageshow', function (event) {
        if (event.persisted || window.performance.getEntriesByType("navigation")[0].type === "back_forward") {
            window.location.href = "{% url 'accueil' %}";
        }
    });
</script>

{% endblock %}
