{% extends 'djassa/djassaman/base.html' %}
{% load custom_filters %}

{% block accueil %}active{% endblock %}
{% block content %}
<main class="container mt-4">
    <div class="container">
        <h3>Bienvenue, {{ user.first_name }}!</h3>
        <a href="{% url 'publication' %}" class="btn btn-primary" id="new-post-btn">Faire une Publication</a>
        <div class="mt-4" id="publications-container">
            {% for publication in publications %}
                <div class="card post-card" data-publication-id="{{ publication.id }}" id="post-{{ publication.id }}">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <a href="{% url 'profilepublication' publication.author.id %}">
                                <img src="{% if publication.author.profile_picture %}{{ publication.author.profile_picture.url }}{% else %}https://placehold.co/120x120{% endif %}"
                                     class="rounded-circle"
                                     style="width: 50px; height: 50px; object-fit: cover;"
                                     loading="lazy">
                            </a>
                            <div class="ml-3">
                                <a href="{% url 'profilepublication' publication.author.id %}">
                                    <h6 class="mb-0">{{ publication.author.first_name }} {{ publication.author.last_name }}</h6>
                                </a>
                                <small class="text-muted">{{ publication.created_at|date:"d M Y, H:i" }}</small>
                            </div>
                        </div>

                        <p class="card-text"> {{ publication.content }}</p>

                        {% if publication.fichier %}
                            {% if publication.is_image %}
                                <img src="{{ publication.fichier.url }}"
                                     class="img-fluid w-100 rounded"
                                     alt="Image de la publication"
                                     loading="lazy"
                                     style="aspect-ratio: 16/9; object-fit: contain; background: #f5f5f5;">
                            {% elif publication.is_video %}
                                <video controls class="w-100 mt-2 rounded" style="aspect-ratio: 16/9; background: #000;">
                                    <source src="{{ publication.fichier.url }}" type="video/mp4">
                                </video>
                            {% endif %}
                        {% endif %}

                        <div class="post-actions mt-3">
                            <a href="javascript:void(0);"
                               class="text-primary like-btn p-0 m-0"
                               data-publication-id="{{ publication.id }}"
                               data-likes-count="{{ publication.likes.count }}">
                                <i class="fas fa-thumbs-up"></i> <span class="like-count">{{ publication.likes.count }}</span>
                            </a>
                            <a href="{% url 'page_commentaire' publication.id %}" class="text-primary ml-3 comment-link"><i class="fas fa-comment"></i> <span class="comment-count">{{ publication.comments.count }}</span></a>
                            <a href="javascript:void(0);" class="text-primary ml-3 share-btn" data-publication-id="{{ publication.id }}"><i class="fas fa-share-alt"></i> <span class="share-count">{{ publication.shares.count }}</span></a>
                            <a href="javascript:void(0);" class="text-primary ml-3 phone-btn" data-phone="{{ publication.author.phone_number }}"><i class="fas fa-phone"></i></a>
                            <a href="mailto:{{ publication.author.email }}" class="text-primary ml-3"><i class="fas fa-envelope"></i></a>
                        </div>
                    </div>
                </div>
            {% empty %}
                <p class="text-center py-4">Aucune publication pour le moment.</p>
            {% endfor %}
        </div>
    </div>
</main>

<!-- Tiroir de téléphone -->
<div id="phone-drawer" class="drawer">
    <div class="drawer-content">
        <button class="close-btn" id="close-phone-drawer">×</button>
        <h4>Appeler l'auteur</h4>
        <p id="phone-number-display"></p>
        <a href="#" class="btn btn-success" id="call-btn">Appeler</a>
    </div>
</div>

<!-- Tiroir de partage -->
<div id="share-drawer" class="drawer">
    <div class="drawer-content">
        <button class="close-btn" id="close-share-drawer">×</button>
        <h4>Choisissez un réseau pour partager</h4>
        <ul class="list-unstyled">
            <li><a id="share-facebook" href="#" target="_blank"><i class="fab fa-facebook"></i> Facebook</a></li>
            <li><a id="share-twitter" href="#" target="_blank"><i class="fab fa-twitter"></i> Twitter</a></li>
            <li><a id="share-whatsapp" href="#" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a></li>
            <li><a id="share-email" href="#" target="_blank"><i class="fas fa-envelope"></i> Email</a></li>
        </ul>
    </div>
</div>

<style>
    /* Styles existants */
    .drawer {
        position: fixed;
        bottom: -100%;
        left: 0;
        width: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        transition: bottom 0.3s ease;
        z-index: 9999;
        display: flex;
        justify-content: center;
    }
    .drawer.open {
        bottom: 0;
    }
    .drawer-content {
        position: relative;
        width: 90%;
        max-width: 400px;
        background: #fff;
        padding: 20px;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        text-align: center;
    }
    .like-btn {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .like-btn.text-success {
        color: #28a745 !important;
    }

    /* Nouveaux styles pour la stabilité du scroll */
    html:not(.drawer-open) {
        scroll-behavior: auto !important;
    }
    body.drawer-open {
        position: fixed;
        width: 100%;
        overflow: hidden;
    }
</style>

<script>
// Gestion robuste du scroll
document.addEventListener('DOMContentLoaded', function() {
    // Sauvegarde de la position avant toute action
    let scrollPosition = 0;

    // Système de restauration du scroll
    function saveScrollPosition() {
        scrollPosition = window.scrollY || document.documentElement.scrollTop;
        sessionStorage.setItem('lastScrollPosition', scrollPosition);
    }

    function restoreScrollPosition() {
        const savedPosition = sessionStorage.getItem('lastScrollPosition');
        if (savedPosition) {
            // Technique de restauration progressive
            const restore = () => {
                window.scrollTo(0, parseInt(savedPosition));
                if (Math.abs(window.scrollY - parseInt(savedPosition)) > 5) {
                    requestAnimationFrame(restore);
                }
            };
            setTimeout(restore, 50);
            setTimeout(restore, 200);
        }
    }

    // Sauvegarder avant toute action
    window.addEventListener('beforeunload', saveScrollPosition);
    document.querySelectorAll('a[href^="#"], .comment-link, #new-post-btn').forEach(el => {
        el.addEventListener('click', saveScrollPosition);
    });

    // Restaurer après chargement
    restoreScrollPosition();

    // Gestion des tiroirs améliorée
    function toggleDrawer(drawerId, open) {
        const drawer = document.getElementById(drawerId);
        if (open) {
            saveScrollPosition();
            document.body.classList.add('drawer-open');
            document.body.style.top = `-${scrollPosition}px`;
            drawer.classList.add('open');
        } else {
            document.body.classList.remove('drawer-open');
            drawer.classList.remove('open');
            window.scrollTo(0, parseInt(document.body.style.top || '0') * -1);
            document.body.style.top = '';
        }
    }

    // Événements des tiroirs
    document.querySelectorAll('.phone-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('phone-number-display').textContent = this.dataset.phone;
            document.getElementById('call-btn').href = `tel:${this.dataset.phone}`;
            toggleDrawer('phone-drawer', true);
        });
    });

    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const pubId = this.dataset.publicationId;
            const baseUrl = `${window.location.origin}{% url 'page_commentaire' 0 %}`.replace('0', pubId);

            document.getElementById('share-facebook').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(baseUrl)}`;
            document.getElementById('share-twitter').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(baseUrl)}`;
            document.getElementById('share-whatsapp').href = `https://api.whatsapp.com/send?text=${encodeURIComponent(baseUrl)}`;
            document.getElementById('share-email').href = `mailto:?subject=Regardez cette publication&body=${encodeURIComponent(baseUrl)}`;

            toggleDrawer('share-drawer', true);
        });
    });

    document.getElementById('close-phone-drawer').addEventListener('click', () => toggleDrawer('phone-drawer', false));
    document.getElementById('close-share-drawer').addEventListener('click', () => toggleDrawer('share-drawer', false));

    // Gestion des likes en Ajax
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const pubId = this.dataset.publicationId;
            const likeCount = this.querySelector('.like-count');

            fetch(`{% url 'like_publication' 0 %}`.replace('0', pubId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `next=${encodeURIComponent(window.location.pathname)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    likeCount.textContent = data.likes_count;
                    this.classList.toggle('text-success');
                }
            });
        });
    });

    // Détection des changements de taille pour éviter les sauts
    let resizeObserver;
    if ('ResizeObserver' in window) {
        resizeObserver = new ResizeObserver(() => {
            if (!document.body.classList.contains('drawer-open')) {
                window.scrollTo(0, scrollPosition);
            }
        });
        document.querySelectorAll('img, video').forEach(el => resizeObserver.observe(el));
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const seenIds = new Set();

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const postId = entry.target.dataset.publicationId;
                if (!seenIds.has(postId)) {
                    seenIds.add(postId);

                    // Envoyer à Django
                    fetch("{% url 'marquer_vues' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({
                            seen_ids: [parseInt(postId)]
                        })
                    });
                }
            }
        });
    }, {
        threshold: 0.75  // Au moins 75% du post doit être visible pour le compter
    });

    document.querySelectorAll('.post-card').forEach(card => {
        observer.observe(card);
    });
});


    // Lors du clic sur le bouton "Like"
document.querySelectorAll('.like-btn').forEach((btn) => {
    btn.addEventListener('click', function () {
        const publicationId = this.dataset.publicationId;
        fetch(`/like_publication/${publicationId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({ publication_id: publicationId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const likesCount = document.querySelector(`#likes-count-${publicationId}`);
                likesCount.textContent = data.likes_count;  // Met à jour le nombre de likes
            }
        });
    });
});
</script>

<script>
    // Récupérer le nom d'utilisateur du destinataire
    const recipientUsername = "{{ recipient.username }}";  // Nom d'utilisateur du destinataire
    const userId = {{ user.id }};  // L'utilisateur authentifié

    // Connexion WebSocket pour la conversation
    const chatSocket = new WebSocket(
        `ws://${window.location.host}/ws/chat/${recipientUsername}/`
    );

    // Recevoir les messages du serveur
    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const likeCountElement = document.querySelector(`#likes-count-${publicationId}`);

        // Met à jour l'UI
        likeCountElement.textContent = data.likes_count;

        // Mise à jour de l'état du bouton "Like"
        const likeButton = document.querySelector(`.like-btn[data-publication-id="${publicationId}"]`);
        if (data.liked) {
            likeButton.classList.add('text-success');
        } else {
            likeButton.classList.remove('text-success');
        }
    };

    // Fonction pour envoyer un "like" ou "unlike"
    function toggleLike() {
        const likeButton = document.querySelector(`.like-btn[data-publication-id="${publicationId}"]`);
        likeButton.classList.toggle('text-success');

        // Envoyer les données au serveur via WebSocket
        socket.send(JSON.stringify({
            'user_id': userId  // Envoyer l'ID de l'utilisateur qui a cliqué
        }));
    }

    // Ajouter un écouteur d'événement pour le bouton "Like"
    document.querySelector('.like-btn[data-publication-id="' + publicationId + '"]').addEventListener('click', toggleLike);
</script>



{% endblock %}